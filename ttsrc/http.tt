| HttpServer HttpHandler HttpRequest HttpResponse |;

HttpServer = Object createWith:
{
    "createWithSocket:", [ :createWithSocket: |
        | inst |;
        inst = this getParent createWith:
        {
            "serverSocket", createWithSocket,
            "handlers", Map new
        };
        inst setParent: this;

        inst registerHandler: (HttpHandler createForPath: "404");
        inst
    ],

    "address:port:", [ :address: :port: |
        |inst|;
        inst = this createWithSocket: (TCPServerSocket openAddress: address port: port);
        inst
    ],

    "start", [ :start |
        | server |;
        server = this;
        Loop
            repeat:
            [
                Loop repeat:
                [
                    | client |;
                    client = serverSocket accept;
                    client isOK ifTrue:
                    [
                        System startThread: [ server handleClient: client ]
                    ]
                ]
                times: 1024
            ]
            times: 1024
    ],

    "handleClient:", [ :handleClient: |
        | end fullRequest lastLine httpRequest |;
        Out writeLine: "Got client";
        end = False;
        fullRequest = "";
        While
            isTrue: [end not]
            do:
            [
                | line |;
                line = handleClient readLine;
				handleClient readLine;
                (line trim equals: "")
                    ifFalse: [ fullRequest = fullRequest append: (line append: "\n") ]
                    ifTrue: [end = True];
                (fullRequest length greaterThan: 32768) ifTrue: [end = True]
            ];

        Out writeLine: "full request:";
        Out writeLine: fullRequest;
		httpRequest = HttpRequest fromHttpHeader: fullRequest;

		| handler httpResponse |;
		handler = handlers getKey: (httpRequest getPath);
		handler isNil ifTrue: [ handler = handlers getKey: "404"];
		Out writeLine: "Got handler for key:";
		Out writeLine: (httpRequest getPath);
		Out writeLine: "Got handler:";
		Out writeLine: (handler toString);
		httpResponse = handler createResponseForRequest: httpRequest;

        handleClient writeLine: (httpResponse getFullResponse);
		handleClient writeLine: "\n<br />";
		handleClient writeLine: "\n<br />";
		handleClient writeLine: "This page was generated by the TinyTalk VM.";
        handleClient close
    ],

    "registerHandler:", [ :registerHandler: |
        handlers addKey: (registerHandler getPath) value: registerHandler
    ]
};

HttpServer

